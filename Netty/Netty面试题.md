参看：

[阿里大牛总结的Netty最全常见面试题，面试再也不怕被问Netty了](https://zhuanlan.zhihu.com/p/148726453)



Netty百万连接优化

1. 操作系统修改连接的最大句柄数，默认1024
2. 优化TCP/IP相关参数
   1. 客户端修改端口范围的限制，1024~65535 理论上单独一个进程最多可以同时建立60000多个TCP客户端连接。
   2. 分配给tcp连接的内存 一个TCP连接大约占7.5KB 
3. 

Netty调优
● 心跳优化
  a. 及时检测失效的连接，将其剔除，方式无效的连接句柄积压，导致OOM等问题
  b. 设置合理的心跳周期，防止心跳定时任务积压，造成频繁的老年代GC(新生代和老年代都有导致STW的GC,不过耗时差异较大),导致应用暂停
  c. 使用Nety提供的链路空闲检测机制,不要自己创建定时任务线程池,加重系统的负担,以及增加潜在的并发安全问题。
● 接收和发送缓冲区调优
  ○ 在一些场景下，端侧设备会周期性地上报数据和发送心跳，单个链路的消息收发量并不大，针对此类场景，可以通过调小TCP的接收和发送缓冲区来降低单个TCP连接的资源占用率
● 合理使用内存池
  ○ 随着JVM虚拟机和JT即时编译技术的发展,对象的分配和回收是一个非常轻量级的工作。但是对于缓冲区 Buffer,情况却稍有不同,特别是堆外直接内存的分配和回收,是一个耗时的操作。Netty默认的IO读写操作采用的都是内存池的堆外直接内存模式,如果用户需要额外使用 ByteBuf,建议也采用内存池方式;如果不涉及网络IO操作(只是纯粹的内存操作),可以使用堆内存池,这样内存的创建效率会更高一些。
● 设置合理的线程数
  ○ boss线程池优化
对于Netty服务端，通常只需要启动一个监听端口用于端侧设备接入，但是如果集群实例较少，甚至是单机部署，那么在短时间内大量设备接入时，需要对服务端的监听方式和线程模型做优化，即服务端监听多个端口，利用主从Reactor线程模型。由于同时监听了多个端口，每个ServerSocketChannel都对应一个独立的Acceptor线程，这样就能并行处理，加速端侧设备的接人速度，减少端侧设备的连接超时失败率，提高单节点服务端的处理性能。
  ○ work线程池优化（IO工作线程池）
对于I/O工作线程池的优化，可以先采用系统默认值（cpu内核数*2）进行性能测试，在性能测试过程中采集I/O线程的CPU占用大小，看是否存在瓶颈。
● I/O线程与业务线程分离
  ○ 如果服务端业务逻辑简单，则可以通过调大NioEventLoop工作线程池的方式，直接在I/O线程执行业务ChannelHandler，这样便减少了一次线程上下文切换，性能反而更高。
  ○ 如果有复杂的业务逻辑，则建议I/O线程与业务线程分离，对于I/O线程，不存在锁竞争，可以创建一个大的NioEventLoopGroup线程组，所有channel共享同一个线程池，对于后端的业务线程，则建议创建多个小的业务线程池，线程池与I/O线程绑定，这样既减少了锁竞争，又提升了后端的处理性能。
JVM层面相关性能优化
  a. 确定GC优化目标，吞吐量，延迟，内存占用，3选2原则。根据业务场景做选择
  b. 垃圾回收器选择，JDK1.8以上版本，建议以选择G1，如果较低版本，可以使用“ParNew+CMS”
    ⅰ. CMS吞吐量调优
      \1. 增加新生代空间，降低新生代GC频率，减少固定时间内新生代GC的次数。
      \2. 增加老年代空间，降低CMS的频率并减少内存碎片，最终减小并发模式失效引起FullGC发生的概率。
      \3. 调整新生代Eden和Survivor 空间的大小比例，减少由新生代晋升到老年代的对象数目，降低CMS GC频率
      \4. 
    ⅱ. G1调优
      \1. 不要使用-Xmn选型或者-XX:NewRatio等其他相关选型显式设置年轻代的大小，这样会覆盖暂停时间指标。
      \2. 暂停时间不要设置得太小，否则为了达到暂停时间目标会增加垃圾回收的开销，影响吞吐量指标。
      \3. 防止触发Full GC:在某些情况下，例如并发模式失败，GI会触发Full GC,这时GI会退化使用Serial 收集器来完成垃圾清理工作，它仅使用单线程来完成GC, GC暂停时间可能会达到秒级。

操作系统级优化
● 最大句柄数修改
  a. Linux默认单进程打开的最大句柄数是1024，当单个推送服务接收到的链接超过上限后，就会报“too many open fules”所有新的客户端接口将失败，
  b. 因此需要根据业务修改最大句柄数
● 优化TCP/IP相关参数
  ○ net.ipv4.ip_local_port_range = 1024 65535: 客户端修改端口范围的限制，如果按上述端口范围进行设置，则理论上单独一个进程最多可以同时建立60000多个TCP客户端连接。
  ○ net.ipv4.tcp_mem = 786432 2097152 3145728： 分配给tcp连接的内存，单位是page（1个Page通常是4KB，可以通过getconf PAGESIZE命令查看），三个值分别是最小、默认、和最大。比如以上配置中的最大是3145728，那分配给tcp的最大内存=31457284 / 1024 / 1024 = 12GB。一个TCP连接大约占7.5KB，粗略可以算出百万连接≈7.5*1000000/4=1875000 3145728足以满足测试所需。