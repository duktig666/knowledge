## 七、程序中出现死锁排查过程

### 7.1 使用jps + jstack

1. 在windows命令窗口，输入 `jps -l`,查询进程ID

   ![image-20211225154713150](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225203620.png)

2. 输入`jstack -l 23056`

   ![image-20211225154636335](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225203620.png)

### 7.2 使用 jconsole

在window打开 JConsole，JConsole是一个图形化的监控工具！

![image-20211225154839786](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225203620.png)

选择要查看的进程，建立连接

来到线程页面，选择检测死锁

<img src="https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225155011.png" alt="image-20211225155011428" style="zoom:50%;" />

如果存在死锁，则可以直接看到

![image-20211225155050616](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225203620.png)

### 7.3 使用 jvisualvm工具

jvisualvm是一个图形化的监控工具，打开工具后选择要查看的进程，可以选择线程，查看是否存在死锁，可以利用线程可视化查看造成死锁的线程，也可以生成线程Dump查看死锁的线程。同时，该工具还可以监控**CPU，堆，类，线程**的运行情况。

<img src="https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225155452.png" alt="image-20211225155452316" style="zoom: 80%;" />

![image-20211225155711244](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225203620.png)

## 八、Java CPU 100% 排查

1. 使用 `top` 命令查看 CPU 占用资源较高的 PID

![top命令](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225203620.png)

2. 【JDK】通过 `jps` 找到当前用户下的 java程序 PID 

   【Linux】通过`ps aux | grep PID`命令

   > 执行 jps -l 能够打印出所有的应用的PID，找到有一个PID和这个cpu使用100%一样的ID！！就知道是哪一个服务了。

3. 【JDK】使用 `pidstat -p3455 -u -t` 找到CPU占用较高的线程

   【Linux】使用 `ps -mp pid -o THREAD,tid,time` 显示线程列表

   > pidstat是sysstat工具的一个命令，用于监控全部或指定进程的cpu、内存、线程、设备IO等系统资源的占用情况。

![这里写图片描述](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20211225201048.png)

4. 将TID转换为十六进制的表示方式

   【Linux】jstack pid |grep tid -A 30

5. 通过jstack -l 输出当前进程的线程信息

   > 使用jstack 输出当前PID的线程dump信息

7. 查找 TID对应的线程(输出的线程id为十六进制)，找到对应的代码

**总结**

1. top命令：Linux命令。可以查看实时的CPU使用情况。也可以查看最近一段时间的CPU使用情况。

2. PS命令：Linux命令。强大的进程状态监控命令。可以查看进程以及进程中线程的当前CPU使用情况。属于当前状态的采样数据。

3. jstack：Java提供的命令。可以查看某个进程的当前线程栈运行情况。根据这个命令的输出可以定位某个进程的所有线程的当前运行状态、运行代码，以及是否死锁等等。

## 九、压力测试如何查看性能

1. 在进行压力测试的时候，使用`jps`找到应用的`PID`
2. 然后使用`jstack`输出出压力测试时候应用的`dump`信息
3. 分析输出的日志文件中那个方法`block`线程占用最多，这里可能是性能有问题，找到对应的代码分析